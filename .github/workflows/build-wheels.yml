name: Build wheels

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-with-profile:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            profile: linux.jinja
            py: "3.10.19"
          - runner: ubuntu-latest
            profile: linux.jinja
            py: "3.14.2"
          - runner: macos-14
            profile: macos.jinja
            py: "3.10.19"
          - runner: macos-14
            profile: macos.jinja
            py: "3.14.2"
          - runner: windows-latest
            profile: windows.jinja
            py: "3.10.19"
          - runner: windows-latest
            profile: windows.jinja
            py: "3.14.2"
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Conan and detect profile
        run: |
          pip install conan
          conan profile detect --force
      - name: Create cpython-portable (${{ matrix.py }})
        run: conan create recipes/cpython --version=${{ matrix.py }}
        shell: bash
      - name: Install backend
        run: pip install -e .
      - name: Build wheels
        run: |
          export CONAN_CPYTHON_VERSION=${{ matrix.py }}
          pip wheel examples/basic --no-build-isolation -C host-profile=../profiles/${{ matrix.profile }} -w examples/basic/dist/
          pip wheel examples/basic-pybind11 --no-build-isolation -C host-profile=../profiles/${{ matrix.profile }} -w examples/basic-pybind11/dist/
        shell: bash
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.runner }}-py${{ matrix.py }}
          path: |
            examples/basic/dist/
            examples/basic-pybind11/dist/

  build-default:
    strategy:
      fail-fast: false
      matrix:
        runner: [ubuntu-latest, macos-14, windows-latest]
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install backend
        run: pip install -e .
      - name: Build wheels
        run: |
          pip wheel examples/basic --no-build-isolation -w examples/basic/dist/
          pip wheel examples/basic-pybind11 --no-build-isolation -w examples/basic-pybind11/dist/
        shell: bash
      - name: Test wheels
        run: |
          pip install examples/basic/dist/myadder-*.whl examples/basic-pybind11/dist/myadder_pybind11-*.whl
          python -c "import myadder; assert myadder.add(2, 3) == 5; assert myadder.add_integers(10, 20) == 30; print('myadder OK')"
          python -c "import myadder_pybind11; assert myadder_pybind11.add(2, 3) == 5; assert myadder_pybind11.add_integers(10, 20) == 30; assert myadder_pybind11.greet('World').startswith('Hello'); print('myadder_pybind11 OK')"
        shell: bash
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.runner }}
          path: |
            examples/basic/dist/
            examples/basic-pybind11/dist/
