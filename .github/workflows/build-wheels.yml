name: Build wheels

on:
  push:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-with-profile:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            profile: linux.jinja
            py: "3.12"
          - runner: macos-14
            profile: macos.jinja
            py: "3.12"
          - runner: windows-latest
            profile: windows.jinja
            py: "3.12"
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Conan and detect profile
        run: |
          pip install conan
          conan profile detect --force
      - name: Create cpython-portable (${{ matrix.py }})
        run: conan create recipes/cpython --version=3.12.12
        shell: bash
      - name: Install backend
        run: pip install -e .
      - name: Build wheels
        env:
          CONAN_CPYTHON_VERSION: ${{ matrix.py }}
        run: |
          pip wheel examples/basic --no-build-isolation -C host-profile=examples/profiles/${{ matrix.profile }} -w examples/basic/dist/
          pip wheel examples/basic-pybind11 --no-build-isolation -C host-profile=examples/profiles/${{ matrix.profile }} -w examples/basic-pybind11/dist/
        shell: bash
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.runner }}-py${{ matrix.py }}
          path: |
            examples/basic/dist/
            examples/basic-pybind11/dist/

  build-default:
    strategy:
      fail-fast: false
      matrix:
        runner: [ubuntu-latest, macos-14]
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install backend
        run: pip install -e .
      - name: Build wheels
        run: |
          pip wheel examples/basic --no-build-isolation -w examples/basic/dist/
          pip wheel examples/basic-pybind11 --no-build-isolation -w examples/basic-pybind11/dist/
        shell: bash
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.runner }}
          path: |
            examples/basic/dist/
            examples/basic-pybind11/dist/
